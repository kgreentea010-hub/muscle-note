<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç­‹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 16px;
    }
    h1 {
      text-align: center;
    }
    .card {
      background: #fff;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
    }
    input,select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    input:not([type="range"]),
ã€€ã€€ã€€ select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      background-color: #fff;
}
    button {
      background: #007aff;
      color: white;
      border: none;
      border-radius: 6px;
    }
    .record {
      margin-top: 6px;
    }
    input[type="checkbox"] {
     width: auto;
     padding: 0;
     margin: 0;
    }
      .delete-btn {
    margin-left: 8px;
    padding: 4px 8px;
    font-size: 12px;
    background: #e53935;
    color: white;
    border: none;
    border-radius: 4px;
    }
    .today-summary {
  background: #f0f8ff;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 10px;
}

.today-summary h3 {
  margin: 0 0 6px 0;
  font-size: 16px;
}

.today-summary .numbers {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
}
.today-summary {
  line-height: 1.6;
}

.summary-date {
  font-weight: bold;
  margin-bottom: 4px;
}

.summary-sets,
.summary-volume {
  font-size: 14px;
}

h3 small {
  font-size: 12px;
  color: #555;
}
    
  </style>
</head>
<body>

<h1>ç­‹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ</h1>

<div class="card">
  <input id="date" type="date">
  
  <select id="part">
  <option value="">éƒ¨ä½ã‚’é¸æŠ</option>
  <option value="èƒ¸">èƒ¸</option>
  <option value="èƒŒä¸­">èƒŒä¸­</option>
  <option value="è„š">è„š</option>
  <option value="è‚©">è‚©</option>
  <option value="è…•">è…•</option>
  <option value="è…¹">è…¹</option>
  </select>
  
  <input id="menu" placeholder="ç¨®ç›®ï¼ˆä¾‹ï¼šãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹ï¼‰">
  <input id="weight" placeholder="é‡é‡ï¼ˆkgï¼‰" type="number">
  <input id="reps" placeholder="å›æ•°" type="number">
  <button onclick="addRecord()">è¨˜éŒ²ã™ã‚‹</button>
  
  <label style="display:flex; align-items:center; gap:8px; margin-top:8px;">
   <input type="checkbox" id="autoRest">
  è¨˜éŒ²å¾Œã«è‡ªå‹•ã§ãƒ¬ã‚¹ãƒˆã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
</label>
  
</div>
<div class="card">
  <h2>ãƒ¬ã‚¹ãƒˆã‚¿ã‚¤ãƒãƒ¼</h2>

  <input
    type="range"
    id="timerRange"
    min="10"
    max="300"
    step="10"
    value="60"
  >

  <div id="timerLabel">60 ç§’</div>

  <button id="startTimer">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button id="stopTimer">åœæ­¢</button>
</div>

<div class="card">
  <h2>è¨˜éŒ²ä¸€è¦§</h2>
  <div id="dailySummary" class="today-summary"></div>
  <div id="records"></div>
</div>
<div class="card">
ã€€<h2>ç¨®ç›®åˆ¥å±¥æ­´</h2>
  <select id="filterMenu">
    <option value="">ç¨®ç›®ã‚’é¸æŠ</option>
  </select>
  <div id="filteredRecords"></div>

  <h3>MAXé‡é‡</h3>
  <div id="maxRecords"></div>
  <button onclick="exportCSV()">CSVæ›¸ãå‡ºã—</button>
</div>

<script>
  const filterMenuEl = document.getElementById("filterMenu");
  const filteredRecordsEl = document.getElementById("filteredRecords");
  const recordsEl = document.getElementById("records");
  const dateEl = document.getElementById("date");
  const autoRestEl = document.getElementById("autoRest");
  const menuEl = document.getElementById("menu");
  const weightEl = document.getElementById("weight");
  const repsEl = document.getElementById("reps");
  const partEl = document.getElementById("part");
  const maxRecordsEl = document.getElementById("maxRecords");
  const timerRange = document.getElementById("timerRange");
  const timerLabel = document.getElementById("timerLabel");
  const startBtn = document.getElementById("startTimer");
  const stopBtn = document.getElementById("stopTimer");
  const dailySummaryEl = document.getElementById("dailySummary");

  let timerId = null;
  let remaining = 0;

  function startRestTimer() {
   if (timerId) return;

   remaining = Number(timerRange.value);
   timerLabel.textContent = `${remaining} ç§’`;
   timerLabel.style.color = "";
   timerLabel.style.fontSize = "";
   timerLabel.style.fontWeight = "";

   timerId = setInterval(() => {
    remaining--;
    timerLabel.textContent = `${remaining} ç§’`;

    if (remaining <= 0) {
      clearInterval(timerId);
      timerId = null;

      timerLabel.textContent = "ä¼‘æ†©çµ‚äº†ï¼";
      timerLabel.style.color = "red";
      timerLabel.style.fontSize = "28px";
      timerLabel.style.fontWeight = "bold";

      playBeep();

      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
    }
  }, 1000);
}

  startBtn.addEventListener("click", startRestTimer);

  stopBtn.addEventListener("click", () => {
  clearInterval(timerId);
  timerId = null;
  timerLabel.textContent = "åœæ­¢ã—ã¾ã—ãŸ";
});

timerRange.addEventListener("input", () => {
  timerLabel.textContent = `${timerRange.value} ç§’`;
});
  
function setToday() {
  const today = new Date().toISOString().slice(0, 10);
  dateEl.value = today;
}
  let records = JSON.parse(localStorage.getItem("records")) || [];

function addRecord() {
  if (!partEl.value) {
  alert("éƒ¨ä½ã‚’é¸æŠã—ã¦ãã ã•ã„");
  return;
}
  if (!menuEl.value || !weightEl.value || !repsEl.value) return;

  // âœ… å…ˆã«ä¿å­˜ï¼ˆpushã®å¤–ï¼‰
  localStorage.setItem("lastMenu", menuEl.value);
  localStorage.setItem("lastWeight", weightEl.value);
  localStorage.setItem("lastDate", dateEl.value);

  records.push({
    date: dateEl.value || new Date().toISOString().slice(0, 10),
    part: partEl.value, 
    menu: menuEl.value,
    weight: Number(weightEl.value),
    reps: Number(repsEl.value)
  });

  // å›æ•°ã ã‘ãƒªã‚»ãƒƒãƒˆ
  repsEl.value = "";
  setToday();

  render();

  if (autoRestEl.checked) {
    startRestTimer();
  }
}
 function updateMenuOptions() {
  const menus = [...new Set(records.map(r => r.menu))];

  filterMenuEl.innerHTML = '<option value="">ç¨®ç›®ã‚’é¸æŠ</option>';

  menus.forEach(menu => {
    const option = document.createElement("option");
    option.value = menu;
    option.textContent = menu;
    filterMenuEl.appendChild(option);
  });
}
  function deleteRecord(record) {
    records = records.filter(r =>
      !(r.date === record.date &&
        r.menu === record.menu &&
        r.weight === record.weight &&
        r.reps === record.reps)
    );
    render();
  }

  function isWithinLast7Days(dateStr) {
   const today = new Date();
   const target = new Date(dateStr);

   const diffDays =
    (today - target) / (1000 * 60 * 60 * 24);

   return diffDays <= 6;
}
  
  function render() {
    const today = new Date().toISOString().slice(0, 10);

    records.forEach(r => {
      if (!r.date) {
       r.date = today;
    }
  });

    recordsEl.innerHTML = "";

    const grouped = {};

    records.forEach(r => {
   if (!grouped[r.date]) hookup = grouped[r.date] = {};
   if (!grouped[r.date][r.part]) grouped[r.date][r.part] = {};
   if (!grouped[r.date][r.part][r.menu]) {
    grouped[r.date][r.part][r.menu] = [];
  }
    grouped[r.date][r.part][r.menu].push(r);
});

    Object.keys(grouped)
  .sort()
  .reverse()
  .forEach(date => {
    
    const dayRecords = records.filter(r => r.date === date);

    // ã‚»ãƒƒãƒˆæ•°
    const totalSets = dayRecords.length;

    // ç·ãƒœãƒªãƒ¥ãƒ¼ãƒ 
    const totalVolume = dayRecords.reduce(
    (sum, r) => sum + r.weight * r.reps,
    0
    );

    // éƒ¨ä½ä¸€è¦§ï¼ˆé‡è¤‡ãªã—ï¼‰
    const partsList = [...new Set(dayRecords.map(r => r.part))];
    const today = new Date().toISOString().slice(0, 10);
    const isRecent = isWithinLast7Days(date);
    const title = document.createElement("h3");

    if (date === today) {
     title.innerHTML = `
     ğŸ”¥ ä»Šæ—¥ (${date})<br>
      <small>
      ${partsList.join("ãƒ»")}ï½œ${totalSets}ã‚»ãƒƒãƒˆï½œç·Vol ${totalVolume.toLocaleString()}kg
      </small>
      `;
      
    title.style.color = "#d32f2f";
    title.style.background = "#ffecec";
    title.style.padding = "6px";
    title.style.borderRadius = "6px";

    } else {
      title.innerHTML = `
       ${date}<br>
      <small>
      ${partsList.join("ãƒ»")}ï½œ${totalSets}ã‚»ãƒƒãƒˆï½œç·Vol ${totalVolume.toLocaleString()}kg
      </small>
     `;
    }

recordsEl.appendChild(title);
    const dayContainer = document.createElement("div");
    dayContainer.style.marginLeft = "8px";

    if (isRecent) {
     dayContainer.style.display = "block";
    } else {
     dayContainer.style.display = "none";
    }

    title.style.cursor = "pointer";

    title.onclick = () => {
     dayContainer.style.display =
      dayContainer.style.display === "none" ? "block" : "none";
    };

recordsEl.appendChild(dayContainer);
    
  if (!isRecent) {
  return;
}
    
    const parts = grouped[date];

Object.keys(parts).forEach(part => {

  // éƒ¨ä½ã‚¿ã‚¤ãƒˆãƒ«
  const partTitle = document.createElement("div");
  const arrow = isRecent ? "â–¼" : "â–¶";
  partTitle.textContent = `${arrow} ${part}`;
  partTitle.style.fontWeight = "bold";
  partTitle.style.marginTop = "8px";
  partTitle.style.background = "#f0f0f0";
  partTitle.style.padding = "6px";
  partTitle.style.borderRadius = "6px";
  partTitle.style.cursor = "pointer";

  // ä¸­èº«ã‚³ãƒ³ãƒ†ãƒŠ
  const partContent = document.createElement("div");
  partContent.style.marginLeft = "8px";

  // ä»Šæ—¥ã ã‘é–‹ã
  partContent.style.display = isRecent ? "block" : "none";

  partTitle.onclick = () => {
  const isOpen = partContent.style.display === "block";
  partContent.style.display = isOpen ? "none" : "block";
  partTitle.textContent = `${isOpen ? "â–¶" : "â–¼"} ${part}`;
};

  dayContainer.appendChild(partTitle);
  dayContainer.appendChild(partContent);

  const menus = parts[part];

  Object.keys(menus).forEach(menu => {
    const menuTitle = document.createElement("div");
    menuTitle.textContent = `â–¼ ${menu}`;
    menuTitle.style.marginTop = "4px";
    menuTitle.style.fontWeight = "bold";
    partContent.appendChild(menuTitle);

    const totalSets = menus[menu].length;

    menus[menu].forEach((r, index) => {
      const div = document.createElement("div");
      div.className = "record";

      div.innerHTML = `
        ${r.weight}kg Ã— ${r.reps}å›ï¼ˆ${index + 1}/${totalSets}ã‚»ãƒƒãƒˆç›®ï¼‰
        <button class="delete-btn">å‰Šé™¤</button>
      `;

      div.querySelector(".delete-btn").onclick = () => {
        if (confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          deleteRecord(r);
        }
      };

      partContent.appendChild(div);
    });
  });
});
    
  });

    localStorage.setItem("records", JSON.stringify(records));
    updateMenuOptions();
    renderMax();
    //renderDailySummary();
  }
function renderDailySummary(grouped, date) {
  dailySummaryEl.innerHTML = "";

  const parts = grouped[date];
  if (!parts) {
    dailySummaryEl.textContent = `ğŸ“Š ${date} ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“`;
    return;
  }

  Object.keys(parts).forEach(part => {
    const partTitle = document.createElement("div");
    partTitle.textContent = `ã€${part}ã€‘`;
    partTitle.style.fontWeight = "bold";
    partTitle.style.marginTop = "8px";
    partTitle.style.background = "#f0f0f0";
    partTitle.style.padding = "6px";
    partTitle.style.borderRadius = "6px";

    dailySummaryEl.appendChild(partTitle);

    const menus = parts[part];

    Object.keys(menus).forEach(menu => {
      const menuTitle = document.createElement("div");
      menuTitle.textContent = `â–¼ ${menu}`;
      menuTitle.style.marginTop = "4px";
      dailySummaryEl.appendChild(menuTitle);

      const totalSets = menus[menu].length;

      menus[menu].forEach((r, index) => {
        const div = document.createElement("div");
        div.className = "record";

        div.innerHTML = `
          ${r.weight}kg Ã— ${r.reps}å›ï¼ˆ${index + 1}/${totalSets}ã‚»ãƒƒãƒˆç›®ï¼‰
          <button class="delete-btn">å‰Šé™¤</button>
        `;

        div.querySelector(".delete-btn").onclick = () => {
          if (confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            deleteRecord(r);
          }
        };

        dailySummaryEl.appendChild(div);
      });
    });
  });
}
function renderMax() {
  maxRecordsEl.innerHTML = "";

  const maxMap = {};

  records.forEach(r => {
    // ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã‚‹å ´åˆã¯ç„¡è¦–
    if (!r.menu || r.weight == null) return;

    const w = Number(r.weight);
    if (!maxMap[r.menu] || w > maxMap[r.menu]) {
      maxMap[r.menu] = w;
    }
  });

  Object.keys(maxMap).forEach(menu => {
    const div = document.createElement("div");
    div.textContent = `${menu}ï¼šMAX ${maxMap[menu]}kg`;
    maxRecordsEl.appendChild(div);
  });
}

function exportCSV() {
  if (records.length === 0) {
    alert("è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  const header = ["æ—¥ä»˜", "ç¨®ç›®", "é‡é‡(kg)", "å›æ•°"];
  const rows = records.map(r => [
    r.date,
    r.menu,
    r.weight,
    r.reps
  ]);

  const csv = [header, ...rows]
    .map(row => row.join(","))
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "workout_records.csv";
  a.click();

  URL.revokeObjectURL(url);
}
filterMenuEl.addEventListener("change", () => {
  const selected = filterMenuEl.value;
  filteredRecordsEl.innerHTML = "";

  if (!selected) return;

  records
    .filter(r => r.menu === selected)
    .forEach(r => {
      const div = document.createElement("div");
      div.className = "record";
      div.textContent = `${r.date}ï½œ${r.weight}kg Ã— ${r.reps}å›`;
      filteredRecordsEl.appendChild(div);
    });
});
  setToday();
  restoreLastInput();
  render();

  //dateEl.addEventListener("change", () => {
  //renderDailySummary();
  //});
  
function playBeep() {
  const audio = new Audio(
    "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="
  );
  audio.play();
}
function restoreLastInput() {
  const lastDate = localStorage.getItem("lastDate");
  const today = new Date().toISOString().slice(0, 10);

  // åŒã˜æ—¥ãªã‚‰å¾©å…ƒ
  if (lastDate === today) {
    menuEl.value = localStorage.getItem("lastMenu") || "";
    weightEl.value = localStorage.getItem("lastWeight") || "";
  } else {
    // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
    localStorage.removeItem("lastMenu");
    localStorage.removeItem("lastWeight");
    localStorage.removeItem("lastDate");
  }
}
  
</script>
</body>
</html>
